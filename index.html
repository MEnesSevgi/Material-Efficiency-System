<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Material Efficiency System - Stok Yönetim Sistemi</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary-color: #2563eb;
      --secondary-color: #64748b;
      --accent-color: #f1f5f9;
      --success-color: #10b981;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --border-color: #e2e8f0;
      --text-color: #334155;
      --bg-color: #f8fafc;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      position: relative;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }

    /* Authentication styles */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      flex-direction: column;
      gap: 40px;
    }

    /* Muhteşem başlık üstte */
    .auth-header {
      font-family: 'Segoe UI Black', 'Arial Black', Arial, sans-serif;
      font-size: 5rem;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      text-align: center;
      user-select: none;
      text-shadow:
        3px 3px 8px rgba(0,0,0,0.5),
        0 0 20px #2563eb,
        0 0 30px #3b82f6;
      animation: glow 2.5s ease-in-out infinite alternate;
      max-width: 90vw;
    }

    @keyframes glow {
      from {
        text-shadow:
          3px 3px 8px rgba(0,0,0,0.5),
          0 0 20px #2563eb,
          0 0 30px #3b82f6;
        color: #2563eb;
      }
      to {
        text-shadow:
          3px 3px 15px rgba(0,0,0,0.8),
          0 0 40px #1e40af,
          0 0 50px #1e40af;
        color: #1e40af;
      }
    }

    .auth-box {
      background: white;
      padding: 2.5rem;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--border-color);
    }

    .auth-tab {
      padding: 1rem 2rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
      user-select: none;
    }

    .auth-tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
      font-weight: 600;
    }

    /* Common styles */
    header {
      background: linear-gradient(135deg, var(--primary-color), #1e40af);
      color: white;
      padding: 2rem;
      text-align: center;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Yeni Material Efficiency System başlığı için stil */
    .mes-title {
      font-size: 3.5rem;       /* Çok büyük puntolar */
      font-weight: 900;        /* Kalın yazı */
      color: var(--primary-color);
      text-align: center;
      letter-spacing: 0.15em;  /* Harf aralığı */
      text-transform: uppercase;
      text-shadow:
        2px 2px 4px rgba(0,0,0,0.15),
        0 0 10px var(--primary-color);
      margin-bottom: 0.3rem;
      font-family: 'Segoe UI Black', 'Arial Black', Arial, sans-serif;
      user-select: none;
      transition: color 0.3s ease;
    }

    .mes-title:hover {
      color: #1e40af;
      text-shadow:
        3px 3px 6px rgba(0,0,0,0.3),
        0 0 15px #1e40af;
      cursor: default;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: #1e40af;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }

    .btn-danger {
      background-color: var(--danger-color);
      color: white;
    }

    .btn-success {
      background-color: var(--success-color);
      color: white;
    }

    .btn-warning {
      background-color: var(--warning-color);
      color: white;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      overflow: auto;
      padding: 20px;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    /* Stock list styles */
    .stock-lists {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .stock-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .stock-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stock-card h3 {
      color: var(--primary-color);
      margin-bottom: 1rem;
    }

    /* Table styles */
    .table-container {
      overflow-x: auto;
      margin: 1rem 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background-color: var(--accent-color);
      font-weight: 600;
      cursor: pointer;
      position: relative;
      user-select: none;
    }

    th:hover {
      background-color: #e2e8f0;
    }

    th.sort-asc::after {
      content: ' ↑';
      font-weight: bold;
    }

    th.sort-desc::after {
      content: ' ↓';
      font-weight: bold;
    }

    /* Filter controls */
    .filter-controls {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1rem 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .filter-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-item input[type='checkbox'] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Navigation */
    .navigation {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    /* Editable excel table styles */
    #editable-table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
    }

    #editable-table th,
    #editable-table td {
      border: 1px solid var(--border-color);
      padding: 8px;
      text-align: left;
      min-width: 80px;
    }

    #editable-table th {
      background-color: var(--accent-color);
      cursor: pointer;
      user-select: none;
    }

    #editable-table td[contenteditable="true"] {
      background-color: #fff;
      cursor: text;
    }

    #editable-table td[contenteditable="true"]:focus {
      outline: 2px solid var(--primary-color);
      background-color: #e0f0ff;
    }

    /* Add buttons container */
    #add-buttons {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <!-- Authentication Page -->
  <div id="auth-page" class="auth-container" role="main" aria-label="Kullanıcı Girişi ve Kayıt">
    <div class="auth-header" aria-hidden="true">Material Efficiency System</div>
    <div class="auth-box" >
      <div class="auth-tabs" role="tablist" aria-label="Giriş ve Kayıt Sekmeleri">
        <div
          class="auth-tab active"
          role="tab"
          tabindex="0"
          aria-selected="true"
          aria-controls="login-form"
          id="login-tab"
          onclick="switchAuthTab('login')"
          onkeydown="if(event.key==='Enter'){switchAuthTab('login')}"
        >
          Giriş Yap
        </div>
        <div
          class="auth-tab"
          role="tab"
          tabindex="0"
          aria-selected="false"
          aria-controls="register-form"
          id="register-tab"
          onclick="switchAuthTab('register')"
          onkeydown="if(event.key==='Enter'){switchAuthTab('register')}"
        >
          Kayıt Ol
        </div>
      </div>

      <div id="login-form" role="tabpanel" aria-labelledby="login-tab">
        <div class="form-group">
          <label for="login-username">Kullanıcı Adı</label>
          <input type="text" id="login-username" placeholder="Kullanıcı adınız" autocomplete="username" />
        </div>
        <div class="form-group">
          <label for="login-password">Şifre</label>
          <input type="password" id="login-password" placeholder="Şifreniz" autocomplete="current-password" />
        </div>
        <button class="btn btn-primary" onclick="login()" style="width: 100%">Giriş Yap</button>
      </div>

      <div id="register-form" role="tabpanel" aria-labelledby="register-tab" style="display: none;">
        <div class="form-group">
          <label for="register-username">Kullanıcı Adı</label>
          <input type="text" id="register-username" placeholder="Kullanıcı adı seçin" autocomplete="username" />
        </div>
        <div class="form-group">
          <label for="register-password">Şifre</label>
          <input type="password" id="register-password" placeholder="Şifre oluşturun" autocomplete="new-password" />
        </div>
        <div class="form-group">
          <label for="register-confirm">Şifre Tekrar</label>
          <input type="password" id="register-confirm" placeholder="Şifreyi tekrar girin" autocomplete="new-password" />
        </div>
        <button class="btn btn-success" onclick="register()" style="width: 100%">Kayıt Ol</button>
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="app-page" style="display: none;">
    <div class="container" role="main">
      <div class="user-info" aria-label="Kullanıcı Bilgisi ve Çıkış">
        <span id="current-user" aria-live="polite">Kullanıcı</span>
        <button class="btn btn-secondary" onclick="logout()">Çıkış Yap</button>
      </div>

      <!-- Ana Sayfa -->
      <div id="main-page">
        <header>
          <h1 class="mes-title">Material Efficiency System</h1>
          <p class="subtitle">Hoş geldiniz, <span id="welcome-user">Kullanıcı</span></p>
        </header>

        <div class="action-buttons">
          <button class="btn btn-primary" onclick="showCreateListModal()">＋ Yeni Stok Listesi Oluştur</button>
        </div>

        <h2>Stok Listelerim</h2>
        <div id="stock-lists-container" class="stock-lists" aria-live="polite" aria-label="Stok Listeleri">
          <!-- Dinamik içerik -->
        </div>
      </div>

      <!-- Liste Detay Sayfası -->
      <div id="list-detail-page" style="display: none;">
        <div class="navigation" role="navigation" aria-label="Sayfa Navigasyonu">
          <button class="btn btn-secondary" onclick="goBack()">← Geri</button>
          <button class="btn btn-danger" onclick="closeList()">✕ Kapat</button>
        </div>

        <header>
          <h1 id="list-detail-title">Liste Detayları</h1>
          <p class="subtitle" id="list-detail-subtitle">Stok verilerinizi yönetin</p>
        </header>

        <div class="action-buttons">
          <input type="file" id="excel-file" accept=".xlsx,.xls" style="display: none" onchange="handleExcelUpload()" />
          <button class="btn btn-primary" onclick="document.getElementById('excel-file').click()">📊 Excel Dosyası Ekle</button>

          <input type="file" id="word-file" accept=".doc,.docx" style="display: none" onchange="handleWordUpload()" />
          <button class="btn btn-primary" onclick="document.getElementById('word-file').click()">📝 Word Dokümanı Ekle</button>

          <button class="btn btn-success" onclick="takeScreenshot()">📸 Ekran Görüntüsü Al</button>
        </div>

        <section class="filter-controls" aria-label="Filtreleme ve Sıralama">
          <h3>Filtreleme ve Sıralama</h3>
          <div id="column-filters" class="filter-grid"></div>
        </section>

        <section id="file-list-container" aria-label="Yüklenen Dosyalar">
          <h3>Yüklenen Dosyalar</h3>
          <div id="files-list"></div>
        </section>

        <div class="loading" id="table-loading" aria-live="polite" aria-busy="false">
          <div class="spinner" role="status" aria-label="Yükleniyor"></div>
          <p>Tablo yükleniyor...</p>
        </div>

        <section id="table-container" class="table-container" tabindex="0" aria-label="Excel Tablosu"></section>

        <!-- Satır ve sütun ekleme butonları -->
        <div id="add-buttons" aria-label="Satır ve sütun ekleme butonları" style="display:none;">
          <button class="btn btn-primary" onclick="addRow()">+ Satır Ekle</button>
          <button class="btn btn-primary" onclick="addColumn()">+ Sütun Ekle</button>
          <button class="btn btn-success" onclick="saveTableChanges()">Tabloyu Kaydet</button>
          <button class="btn btn-warning" onclick="exportFilteredExcel()">Excel'i Dışa Aktar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pencereler -->
  <div id="create-list-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="create-list-title">
    <div class="modal-content">
      <h2 id="create-list-title">Yeni Stok Listesi Oluştur</h2>
      <div class="form-group">
        <label for="list-name">Liste Adı</label>
        <input type="text" id="list-name" placeholder="Liste adını giriniz" />
      </div>
      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button class="btn btn-primary" onclick="createStockList()">Oluştur</button>
        <button class="btn btn-secondary" onclick="hideModal('create-list-modal')">İptal</button>
      </div>
    </div>
  </div>

  <script>
    // Global değişkenler
    let currentUser = null;
    let currentList = null;
    let currentTableData = [];
    let currentFilters = {};
    let currentSort = { column: null, direction: 'asc' };

    document.addEventListener('DOMContentLoaded', () => {
      checkAuthStatus();
    });

    // Auth sekme geçişi
    function switchAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach((t) => t.classList.remove('active'));
      document.querySelector(`.auth-tab:nth-child(${tab === 'login' ? 1 : 2})`).classList.add('active');

      document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
      document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
    }

    // Kayıt olma fonksiyonu
    function register() {
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value;
      const confirm = document.getElementById('register-confirm').value;

      if (!username || !password) {
        alert('Lütfen kullanıcı adı ve şifre giriniz.');
        return;
      }

      if (password !== confirm) {
        alert('Şifreler eşleşmiyor.');
        return;
      }

      if (password.length < 4) {
        alert('Şifre en az 4 karakter olmalıdır.');
        return;
      }

      const users = JSON.parse(localStorage.getItem('users') || '{}');

      if (users[username]) {
        alert('Bu kullanıcı adı zaten kullanımda.');
        return;
      }

      users[username] = {
        password: password,
        createdAt: new Date().toISOString(),
        stockLists: [],
      };

      localStorage.setItem('users', JSON.stringify(users));
      alert('Kayıt başarılı! Giriş yapabilirsiniz.');
      switchAuthTab('login');
    }

    // Giriş yapma fonksiyonu
    function login() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;

      if (!username || !password) {
        alert('Lütfen kullanıcı adı ve şifre giriniz.');
        return;
      }

      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const user = users[username];

      if (!user || user.password !== password) {
        alert('Kullanıcı adı veya şifre hatalı.');
        return;
      }

      currentUser = username;
      localStorage.setItem('currentUser', username);
      showAppPage();
    }

    // Çıkış yapma fonksiyonu
    function logout() {
      currentUser = null;
      localStorage.removeItem('currentUser');
      showAuthPage();
    }

    // Oturum kontrolü
    function checkAuthStatus() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = savedUser;
        showAppPage();
      } else {
        showAuthPage();
      }
    }

    // Sayfa gösterimleri
    function showAuthPage() {
      document.getElementById('auth-page').style.display = 'flex';
      document.getElementById('app-page').style.display = 'none';
    }

    function showAppPage() {
      document.getElementById('auth-page').style.display = 'none';
      document.getElementById('app-page').style.display = 'block';
      document.getElementById('welcome-user').textContent = currentUser;
      document.getElementById('current-user').textContent = currentUser;
      loadStockLists();
    }

    // Modal işlemleri
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
      const focusable = modal.querySelector('input,button,[tabindex]:not([tabindex="-1"])');
      if (focusable) focusable.focus();
    }

    function hideModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }

    // Yeni stok listesi oluşturma
    function showCreateListModal() {
      document.getElementById('list-name').value = '';
      showModal('create-list-modal');
    }

    function createStockList() {
      const listName = document.getElementById('list-name').value.trim();

      if (!listName) {
        alert('Lütfen bir liste adı giriniz.');
        return;
      }

      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const user = users[currentUser];

      if (user.stockLists.some((list) => list.name.toLowerCase() === listName.toLowerCase())) {
        alert('Bu isimde bir liste zaten mevcut.');
        return;
      }

      const newList = {
        id: Date.now().toString(),
        name: listName,
        files: [],
        created: new Date().toISOString(),
        shares: [],
        products: [],
        stockMovements: [],
      };

      user.stockLists.push(newList);
      localStorage.setItem('users', JSON.stringify(users));
      loadStockLists();
      hideModal('create-list-modal');

      alert('Liste başarıyla oluşturuldu: ' + listName);
    }

    // Stok listelerini yükleme
    function loadStockLists() {
      const container = document.getElementById('stock-lists-container');
      container.innerHTML = '';

      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const user = users[currentUser];
      const lists = user?.stockLists || [];

      if (lists.length === 0) {
        container.innerHTML = '<p>Henüz hiç stok listesi oluşturulmamış.</p>';
        return;
      }

      lists.forEach((list) => {
        const card = document.createElement('div');
        card.className = 'stock-card';
        card.innerHTML = `
          <h3>${list.name}</h3>
          <p>Oluşturulma: ${new Date(list.created).toLocaleDateString('tr-TR')}</p>
          <p>Dosya Sayısı: ${list.files.length}</p>
        `;
        card.onclick = () => openList(list.id);
        card.tabIndex = 0;
        card.setAttribute('role', 'button');
        card.setAttribute('aria-pressed', 'false');
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openList(list.id);
          }
        });
        container.appendChild(card);
      });
    }

    // Liste detaylarını açma
    function openList(listId) {
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const user = users[currentUser];
      currentList = user.stockLists.find((list) => list.id === listId);

      if (!currentList) return;

      if (!currentList.products) currentList.products = [];
      if (!currentList.stockMovements) currentList.stockMovements = [];

      document.getElementById('main-page').style.display = 'none';
      document.getElementById('list-detail-page').style.display = 'block';
      document.getElementById('list-detail-title').textContent = currentList.name;
      document.getElementById('list-detail-subtitle').textContent = `${currentList.files.length} dosya`;

      loadListFiles();
      clearTableAndFilters();
      document.getElementById('export-excel-btn')?.style.display && (document.getElementById('export-excel-btn').style.display = 'none');

      renderProductsTable();
      renderStockMovements();
    }

    function goBack() {
      document.getElementById('main-page').style.display = 'block';
      document.getElementById('list-detail-page').style.display = 'none';
      currentList = null;
      currentTableData = [];
      currentFilters = {};
      currentSort = { column: null, direction: 'asc' };
      clearTableAndFilters();
      document.getElementById('export-excel-btn')?.style.display && (document.getElementById('export-excel-btn').style.display = 'none');
      document.getElementById('add-buttons').style.display = 'none';
    }

    function closeList() {
      goBack();
    }

    // Dosyaları listele
    function loadListFiles() {
      const container = document.getElementById('files-list');
      container.innerHTML = '';

      if (!currentList.files.length) {
        container.innerHTML = '<p>Henüz hiç dosya yüklenmemiş.</p>';
        return;
      }

      currentList.files.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.style.cssText =
          'padding: 12px; margin: 8px 0; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;';

        if (file.type === 'excel') {
          fileItem.innerHTML = `
            <span>📊 ${file.name} (${file.data.length - 1} satır)</span>
            <div>
              <button class="btn btn-primary" onclick="showExcelData(${index})" aria-label="Excel dosyasını göster">Göster</button>
              <button class="btn btn-danger" onclick="deleteFile(${index})" aria-label="Dosyayı sil">Sil</button>
            </div>
          `;
        } else {
          fileItem.innerHTML = `
            <span>📝 ${file.name}</span>
            <div>
              <button class="btn btn-primary" onclick="previewWord(${index})" aria-label="Word dokümanını indir">İndir</button>
              <button class="btn btn-danger" onclick="deleteFile(${index})" aria-label="Dosyayı sil">Sil</button>
            </div>
          `;
        }

        container.appendChild(fileItem);
      });
    }

    // Excel dosyası yükleme
    function handleExcelUpload() {
      const fileInput = document.getElementById('excel-file');
      const file = fileInput.files[0];

      if (!file) return;

      showLoading(true);

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

          const excelFile = {
            type: 'excel',
            name: file.name,
            data: jsonData,
            uploaded: new Date().toISOString(),
          };

          const users = JSON.parse(localStorage.getItem('users') || '{}');
          const user = users[currentUser];
          const listIndex = user.stockLists.findIndex((list) => list.id === currentList.id);

          user.stockLists[listIndex].files.push(excelFile);
          localStorage.setItem('users', JSON.stringify(users));

          currentList = user.stockLists[listIndex];
          loadListFiles();

          alert('Excel dosyası başarıyla yüklendi!');
        } catch (error) {
          alert('Excel dosyası okunurken hata oluştu: ' + error.message);
        } finally {
          showLoading(false);
        }
      };

      reader.readAsArrayBuffer(file);
      fileInput.value = '';
    }

    // Word dosyası yükleme - base64 olarak kaydedilir
    function handleWordUpload() {
      const fileInput = document.getElementById('word-file');
      const file = fileInput.files[0];

      if (!file) return;

      showLoading(true);

      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result;

        const wordFile = {
          type: 'word',
          name: file.name,
          content: content,
          uploaded: new Date().toISOString(),
        };

        const users = JSON.parse(localStorage.getItem('users') || '{}');
        const user = users[currentUser];
        const listIndex = user.stockLists.findIndex((list) => list.id === currentList.id);

        user.stockLists[listIndex].files.push(wordFile);
        localStorage.setItem('users', JSON.stringify(users));

        currentList = user.stockLists[listIndex];
        loadListFiles();

        alert('Word dokümanı başarıyla yüklendi!');
        showLoading(false);
        fileInput.value = '';
      };

      reader.readAsDataURL(file);
    }

    // Excel verisini göster (düzenlenebilir tablo ile)
    function showExcelData(fileIndex) {
      const file = currentList.files[fileIndex];
      if (!file || file.type !== 'excel') return;

      showLoading(true);

      setTimeout(() => {
        currentTableData = file.data;
        setupColumnFilters(file.data[0]);
        currentSort = { column: null, direction: 'asc' };
        displayTable(currentTableData);
        showLoading(false);
        document.getElementById('add-buttons').style.display = 'flex';
      }, 100);
    }

    // Tabloyu göster (düzenlenebilir hücrelerle)
    function displayTable(data) {
      const container = document.getElementById('table-container');
      if (!data || data.length === 0) {
        container.innerHTML = '<p>Gösterilecek veri bulunamadı.</p>';
        document.getElementById('add-buttons').style.display = 'none';
        return;
      }

      let filteredData = filterData(data);
      filteredData = sortData(filteredData);

      if (filteredData.length <= 1) {
        container.innerHTML = '<p>Seçili sütunlarda veri bulunamadı.</p>';
        document.getElementById('add-buttons').style.display = 'none';
        return;
      }

      let tableHTML = '<table id="editable-table" aria-label="Düzenlenebilir Excel Tablosu"><thead><tr>';

      filteredData[0].forEach((header) => {
        if (currentFilters[header]) {
          const isSorted = currentSort.column === header;
          const sortClass = isSorted ? `sort-${currentSort.direction}` : '';
          tableHTML += `<th class="${sortClass}" tabindex="0" role="columnheader" aria-sort="${
            isSorted ? (currentSort.direction === 'asc' ? 'ascending' : 'descending') : 'none'
          }" onclick="sortTable('${header}')" onkeydown="if(event.key==='Enter'){sortTable('${header}')}" >${escapeHtml(header)}</th>`;
        }
      });

      tableHTML += '</tr></thead><tbody>';

      for (let i = 1; i < filteredData.length; i++) {
        tableHTML += '<tr>';
        filteredData[i].forEach((cell) => {
          tableHTML += `<td contenteditable="true">${escapeHtml(cell || '')}</td>`;
        });
        tableHTML += '</tr>';
      }

      tableHTML += '</tbody></table>';

      container.innerHTML = tableHTML;
    }

    // Satır ekleme
    function addRow() {
      if (!currentTableData || currentTableData.length === 0) return;

      // Yeni boş satır: sütun sayısı kadar boş string
      const colCount = currentTableData[0].length;
      const newRow = new Array(colCount).fill('');
      currentTableData.push(newRow);

      displayTable(currentTableData);
    }

    // Sütun ekleme (kullanıcıdan başlık alarak)
    function addColumn() {
      if (!currentTableData || currentTableData.length === 0) return;

      let newHeader = prompt('Yeni sütun başlığını giriniz:');
      if (newHeader === null) return; // İptal edildi
      newHeader = newHeader.trim();
      if (!newHeader) {
        alert('Başlık boş olamaz.');
        return;
      }

      // Başlık zaten varsa uyar
      if (currentTableData[0].includes(newHeader)) {
        alert('Bu başlık zaten mevcut.');
        return;
      }

      // Başlığı ekle
      currentTableData[0].push(newHeader);

      // Diğer satırlara boş hücre ekle
      for (let i = 1; i < currentTableData.length; i++) {
        currentTableData[i].push('');
      }

      // Filtrelerde yeni sütunu aktif yap
      currentFilters[newHeader] = true;

      setupColumnFilters(currentTableData[0]);
      displayTable(currentTableData);
    }

    // Tablo kaydetme fonksiyonu
    function saveTableChanges() {
      const table = document.getElementById('editable-table');
      if (!table) return;

      const rows = table.querySelectorAll('tr');
      const newData = [];

      rows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll(rowIndex === 0 ? 'th' : 'td');
        const rowData = [];
        cells.forEach(cell => {
          rowData.push(cell.textContent.trim());
        });
        newData.push(rowData);
      });

      const excelFile = currentList.files.find(f => f.type === 'excel');
      if (!excelFile) {
        alert('Excel dosyası bulunamadı.');
        return;
      }

      excelFile.data = newData;
      currentTableData = newData;

      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const user = users[currentUser];
      const listIndex = user.stockLists.findIndex(list => list.id === currentList.id);

      const fileIndex = user.stockLists[listIndex].files.findIndex(f => f.name === excelFile.name && f.type === 'excel');

      if (fileIndex === -1) {
        alert('Dosya bulunamadı.');
        return;
      }

      user.stockLists[listIndex].files[fileIndex].data = newData;
      localStorage.setItem('users', JSON.stringify(users));

      alert('Tablo başarıyla kaydedildi!');
    }

    // HTML escape fonksiyonu
    function escapeHtml(text) {
      if (!text) return '';
      return text
        .toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Filtreleme (sadece tikli sütunları göster)
    function filterData(data) {
      if (Object.keys(currentFilters).length === 0) return data;

      const headers = data[0];
      const visibleIndexes = headers.reduce((acc, header, idx) => {
        if (currentFilters[header]) acc.push(idx);
        return acc;
      }, []);

      return data.map((row) => visibleIndexes.map((i) => row[i]));
    }

    // Sıralama
    function sortData(data) {
      if (!currentSort.column || data.length <= 1) return data;

      const headerIndex = data[0].indexOf(currentSort.column);
      if (headerIndex === -1) return data;

      const headers = data[0];
      const sortedData = [
        headers,
        ...data
          .slice(1)
          .slice()
          .sort((a, b) => {
            const valA = a[headerIndex];
            const valB = b[headerIndex];

            if (!isNaN(valA) && !isNaN(valB)) {
              return currentSort.direction === 'asc' ? valA - valB : valB - valA;
            }

            return currentSort.direction === 'asc'
              ? String(valA).localeCompare(String(valB))
              : String(valB).localeCompare(String(valA));
          }),
      ];

      return sortedData;
    }

    // Filtre kontrollerini kur
    function setupColumnFilters(headers) {
      const filtersContainer = document.getElementById('column-filters');
      filtersContainer.innerHTML = '';

      currentFilters = {};
      headers.forEach((header) => {
        currentFilters[header] = true;
      });

      headers.forEach((header) => {
        const filterItem = document.createElement('div');
        filterItem.className = 'filter-item';
        filterItem.innerHTML = `
          <input type="checkbox" id="filter-${header}" checked onchange="toggleColumn('${header}')" />
          <label for="filter-${header}">${escapeHtml(header)}</label>
        `;
        filtersContainer.appendChild(filterItem);
      });
    }

    // Sütun gizle/göster
    function toggleColumn(columnName) {
      const checkbox = document.getElementById(`filter-${columnName}`);
      currentFilters[columnName] = checkbox.checked;

      if (currentTableData.length > 0) {
        displayTable(currentTableData);
      }
    }

    // Tablo sıralama
    function sortTable(columnName) {
      if (currentSort.column === columnName) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = columnName;
        currentSort.direction = 'asc';
      }

      if (currentTableData.length > 0) {
        displayTable(currentTableData);
      }
    }

    // Word dosyasını indirme fonksiyonu
    function previewWord(fileIndex) {
      const file = currentList.files[fileIndex];
      if (!file || file.type !== 'word') return;

      const link = document.createElement('a');
      link.href = file.content;
      link.download = file.name;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      alert('Word dosyası indirildi. Dosyayı açmak için bilgisayarınızdaki Word programını kullanabilirsiniz.');
    }

    // Ekran görüntüsü alma
    function takeScreenshot() {
      if (currentTableData.length === 0) {
        alert('Gösterilecek tablo bulunamadı.');
        return;
      }

      html2canvas(document.getElementById('table-container')).then((canvas) => {
        const link = document.createElement('a');
        link.download = `stok-tablosu-${currentList.name}-${new Date().toISOString().slice(0, 10)}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    }

    // Dosya silme
    function deleteFile(fileIndex) {
      if (confirm('Bu dosyayı silmek istediğinize emin misiniz?')) {
        const users = JSON.parse(localStorage.getItem('users') || '{}');
        const user = users[currentUser];
        const listIndex = user.stockLists.findIndex((list) => list.id === currentList.id);

        user.stockLists[listIndex].files.splice(fileIndex, 1);
        localStorage.setItem('users', JSON.stringify(users));

        currentList = user.stockLists[listIndex];
        loadListFiles();
        clearTableAndFilters();
        document.getElementById('add-buttons').style.display = 'none';
      }
    }

    // Yükleniyor göstergesi
    function showLoading(show) {
      const loading = document.getElementById('table-loading');
      loading.style.display = show ? 'block' : 'none';
      loading.setAttribute('aria-busy', show ? 'true' : 'false');
    }

    // Tablo ve filtreleri temizle
    function clearTableAndFilters() {
      document.getElementById('table-container').innerHTML = '';
      document.getElementById('column-filters').innerHTML = '';
      currentFilters = {};
      currentSort = { column: null, direction: 'asc' };
      currentTableData = [];
      document.getElementById('add-buttons').style.display = 'none';
    }

    // Excel dışa aktarma
    function exportFilteredExcel() {
      if (!currentTableData || currentTableData.length === 0) {
        alert('Dışa aktarılacak tablo bulunamadı.');
        return;
      }

      let filteredData = filterData(currentTableData);
      filteredData = sortData(filteredData);

      if (filteredData.length <= 1) {
        alert('Dışa aktarılacak veri bulunamadı.');
        return;
      }

      const ws = XLSX.utils.aoa_to_sheet(filteredData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Filtrelenmiş Tablo');

      const fileName = `filtrelenmis-stok-tablosu-${currentList.name}-${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    // --- Aşağıdaki ürün ve hareketler ile ilgili fonksiyonlar kaldırıldı ---
    function renderProductsTable() {}
    function updateStock() {}
    function renderStockMovements() {}
  </script>
</body>
</html>
